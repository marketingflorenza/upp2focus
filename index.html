<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2 Sales Dashboard (Standardized & Fixed)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0d6efd;
            --success: #198754;
            --warning: #ffc107;
            --purple: #6610f2;
            --gray: #6c757d;
            --danger: #dc3545;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Kanit', sans-serif; }
        body { background-color: #f4f7f6; color: #1a1a1a; line-height: 1.6; }
        .container { max-width: 1500px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, var(--primary) 0%, #0dcaf0 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(13,110,253,0.2); }
        
        .controls-section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: center; margin-bottom: 20px; }
        .filter-group { display: flex; align-items: center; gap: 10px; }
        select, input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: var(--gray); color: white; }
        .btn:disabled { opacity: 0.5; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; border-left: 6px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
        .kpi-card.total-up { border-color: var(--purple); }
        .kpi-card.p1 { border-color: var(--success); }
        .kpi-card.up-p2 { border-color: var(--warning); }
        .kpi-card.unconverted { border-color: var(--gray); }
        .kpi-title { color: #6c757d; font-size: 13px; margin-bottom: 8px; text-transform: uppercase; font-weight: 600; }
        .kpi-value { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
        .kpi-percent { font-size: 14px; font-weight: 500; color: var(--success); }

        .content-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 992px) { .content-layout { grid-template-columns: 1fr; } }
        
        .card-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .table-container { overflow-x: auto; margin-top: 15px; border-radius: 8px; border: 1px solid #eee; max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8f9fa; padding: 12px 15px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #ddd; }
        td { padding: 10px 15px; border-bottom: 1px solid #f1f1f1; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .bg-p1 { background: #d1e7dd; color: #0f5132; }
        .bg-up-p2 { background: #fff3cd; color: #664d03; }
        .bg-wait { background: #e2e3e5; color: #41464b; }
        .bg-danger-light { background: #f8d7da; color: #842029; }

        #statusMessage { font-size: 14px; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Sales & Conversion (P2 Focus)</h1>
        <p>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
    </div>

    <div class="controls-section">
        <div class="filter-group">
            <select id="branchSelector">
                <option value="Choc">Choc (‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà)</option>
                <option value="Bangyai">Bangyai (‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø)</option>
                <option value="Sriracha">Sriracha (‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ)</option>
                <option value="Ram">Ram (‡∏£‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤)</option>
                <option value="Bornsong">Bornsong</option>
            </select>
            <button class="btn btn-primary" onclick="fetchData()" id="loadBtn">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <div class="filter-group">
            <input type="date" id="startDate">
            <span>‡∏ñ‡∏∂‡∏á</span>
            <input type="date" id="endDate">
            <button class="btn btn-success" onclick="processAnalysis()" id="filterBtn" disabled>üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <div id="statusMessage"></div>
    </div>

    <div id="dashboardContent" style="display: none;">
        <div class="dashboard-grid">
            <div class="kpi-card">
                <div class="kpi-title">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ P2</div>
                <div class="kpi-value" id="totalP2">0</div>
            </div>
            <div class="kpi-card total-up">
                <div class="kpi-title">üíú ‡∏ö‡∏¥‡∏• UP P2 ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
                <div class="kpi-value" id="totalAllUpP2">0</div>
            </div>
            <div class="kpi-card p1">
                <div class="kpi-title">‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô P1</div>
                <div class="kpi-value" id="countP1">0</div>
                <div class="kpi-percent" id="percP1">0%</div>
            </div>
            <div class="kpi-card up-p2">
                <div class="kpi-title">‚ö†Ô∏è UP P2 (‡∏à‡∏≤‡∏Å P2 ‡πÄ‡∏î‡∏¥‡∏°)</div>
                <div class="kpi-value" id="countUpP2">0</div>
                <div class="kpi-percent" id="percUpP2">0%</div>
            </div>
            <div class="kpi-card unconverted">
                <div class="kpi-title">‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
                <div class="kpi-value" id="countNone">0</div>
                <div class="kpi-percent" style="color:#6c757d" id="percNone">0%</div>
            </div>
        </div>

        <div class="content-layout">
            <div class="card-box">
                <h3 style="text-align:center;">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô Conversion</h3>
                <div style="height: 300px;"><canvas id="mainChart"></canvas></div>
            </div>
            <div class="card-box">
                <h3>üèÜ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ UP P2 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå K)</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>Sale</th>
                            </tr>
                        </thead>
                        <tbody id="successTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card-box" style="margin-top: 20px;">
            <h3 style="color: var(--danger);">üö© ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ P2 ‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)</h3>
            <div class="table-container" style="max-height: none;">
                <table>
                    <thead>
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà P2 Lead</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
                            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</th>
                            <th style="color: var(--primary);">‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>Sale ‡∏î‡∏π‡πÅ‡∏•</th>
                            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let rawData = [];
    let myChart = null;
    let colMap = { p1: 8, upP2: 10, p2: 13, date: 1, name: 2, phone: 3, note: 6, appt: 7, interest: 5, sale: 0 };

    const SHEETS = {
        'Choc': '1F2bTvP1ySUT1q6fzRPQu7UpKNW_ze8GtKkd2rmRUjkI',
        'Bangyai': '1JU-rhoWIEHH4oSwIWApo8mUC8zQpNcT0Xd-70E_6CNM',
        'Sriracha': '1PdYqXkrrRGIv-6cCgOn8VXE6MpQhMlBGpFw7BbfzFbI',
        'Ram': '1LFoETe4YdPIxxj27bXxNRip9dKJ-sL7bbDv820ExEtk',
        'Bornsong': '1dlgM7YaQmJQTuiuNdAMb6tjKHllPgIs8MjfgGZnp8jU'
    };

    async function fetchData() {
        const branch = document.getElementById('branchSelector').value;
        const msg = document.getElementById('statusMessage');
        const url = `https://docs.google.com/spreadsheets/d/${SHEETS[branch]}/gviz/tq?tqx=out:csv`;

        msg.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        try {
            const resp = await fetch(url);
            const text = await resp.text();
            rawData = parseCSV(text);
            
            // Detect Columns
            if (rawData.length > 0) {
                const headers = Object.keys(rawData[0]);
                const find = (keys) => headers.findIndex(h => keys.some(k => h.toLowerCase().includes(k.toLowerCase())));
                const p1 = find(['p1', '‡∏¢‡∏≠‡∏î‡∏à‡∏≠‡∏á']); if(p1!==-1) colMap.p1 = p1;
                const up = find(['‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û p2', '‡∏≠‡∏±‡∏û p2', 'upp2']); if(up!==-1) colMap.upP2 = up;
                const p2 = find(['p2']); if(p2!==-1) colMap.p2 = p2;
            }

            msg.innerHTML = `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${rawData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            document.getElementById('filterBtn').disabled = false;
            document.getElementById('dashboardContent').style.display = 'block';

            const now = new Date();
            document.getElementById('startDate').valueAsDate = new Date(now.getFullYear(), now.getMonth(), 1);
            document.getElementById('endDate').valueAsDate = now;
            processAnalysis();
        } catch (e) {
            msg.innerHTML = "‚ùå Error: " + e.message;
        }
    }

    function parseCSV(text) {
        const lines = text.split('\n');
        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
        return lines.slice(1).map(line => {
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const obj = {};
            headers.forEach((h, i) => obj[h] = values[i] ? values[i].replace(/"/g, '').trim() : '');
            return obj;
        });
    }

    function robustParseDate(s) {
        if (!s) return null;
        const p = s.split(/[\-\/]/);
        if (p.length < 3) return null;
        let d = parseInt(p[0]), m = parseInt(p[1]), y = parseInt(p[2]);
        if (p[0].length === 4) { y=parseInt(p[0]); m=parseInt(p[1]); d=parseInt(p[2]); }
        else if (m > 12) { m = parseInt(p[0]); d = parseInt(p[1]); }
        if (y > 2500) y -= 543;
        if (y < 100) y += 2000;
        return new Date(y, m - 1, d);
    }

    function cleanNum(v) {
        if (!v) return 0;
        return parseFloat(String(v).replace(/[^\d.-]/g, '')) || 0;
    }

    function processAnalysis() {
        const start = new Date(document.getElementById('startDate').value);
        const end = new Date(document.getElementById('endDate').value);
        start.setHours(0,0,0,0); end.setHours(23,59,59,999);

        const users = {};
        const successRows = [];
        const h = Object.keys(rawData[0]);

        // 1. Organize histories and capture Purple KPI
        let allUpP2Count = 0;
        rawData.forEach(row => {
            const date = robustParseDate(row[h[colMap.date]]);
            if (!date) return;
            const name = row[h[colMap.name]]?.replace(/^‡∏Ñ‡∏∏‡∏ì/, '').trim();
            const phone = row[h[colMap.phone]]?.trim();
            const uid = phone && phone.length > 5 ? phone : name;
            if (!uid) return;

            const upP2Val = cleanNum(row[h[colMap.upP2]]);
            const note = row[h[colMap.note]]?.toUpperCase() || '';
            const isUpP2 = upP2Val > 0 || note.includes('UP P2') || note.includes('UPP2');

            if (date >= start && date <= end && isUpP2) {
                allUpP2Count++;
                successRows.push({ date, name, amt: upP2Val, sale: row[h[colMap.sale]], note });
            }

            if (!users[uid]) users[uid] = [];
            users[uid].push({
                ...row,
                _date: date,
                _isP2: row[h[colMap.p2]] !== '' || note === 'P2',
                _p1: cleanNum(row[h[colMap.p1]]),
                _upP1: cleanNum(row[h[10]]), // Common UP P1 pos
                _upP2: upP2Val,
                _note: note,
                _appt: row[h[colMap.appt]]
            });
        });

        let p2Targets = 0, p1Conv = 0, upP2Conv = 0;
        const pendingList = [];

        for (const id in users) {
            const logs = users[id].sort((a,b) => a._date - b._date);
            logs.forEach((log, idx) => {
                if (log._isP2 && log._date >= start && log._date <= end && !log._note.includes('UP')) {
                    p2Targets++;
                    let converted = false;
                    for (let i = idx; i < logs.length; i++) {
                        const n = logs[i];
                        if (n._p1 > 0 || (n._note.includes('P1') && !n._note.includes('UP'))) { p1Conv++; converted = true; break; }
                        if (n._upP2 > 0 || n._note.includes('UP P2')) { upP2Conv++; converted = true; break; }
                    }
                    if (!converted) {
                        pendingList.push({
                            date: log._date,
                            name: log[h[colMap.name]],
                            phone: log[h[colMap.phone]],
                            interest: log[h[colMap.interest]],
                            appt: log._appt,
                            sale: log[h[colMap.sale]],
                            note: log._note
                        });
                    }
                }
            });
        }

        // Update UI
        document.getElementById('totalP2').innerText = p2Targets;
        document.getElementById('totalAllUpP2').innerText = allUpP2Count;
        document.getElementById('countP1').innerText = p1Conv;
        document.getElementById('countUpP2').innerText = upP2Conv;
        const none = Math.max(0, p2Targets - p1Conv - upP2Conv);
        document.getElementById('countNone').innerText = none;

        const perc = (v) => p2Targets > 0 ? ((v/p2Targets)*100).toFixed(1) + '%' : '0%';
        document.getElementById('percP1').innerText = perc(p1Conv);
        document.getElementById('percUpP2').innerText = perc(upP2Conv);
        document.getElementById('percNone').innerText = perc(none);

        // Update Tables
        const successBody = document.getElementById('successTableBody');
        successBody.innerHTML = successRows.sort((a,b)=>b.date-a.date).map(r => `
            <tr>
                <td>${r.date.toLocaleDateString('th-TH')}</td>
                <td><b>${r.name}</b></td>
                <td style="color:var(--purple); font-weight:600;">${r.amt.toLocaleString()}</td>
                <td><span class="badge bg-up-p2">UP P2</span></td>
                <td>${r.sale || '-'}</td>
            </tr>
        `).join('');

        const pendingBody = document.getElementById('pendingTableBody');
        pendingBody.innerHTML = pendingList.map(r => `
            <tr>
                <td>${r.date.toLocaleDateString('th-TH')}</td>
                <td><b>${r.name}</b></td>
                <td>${r.phone || '-'}</td>
                <td style="font-size:12px;">${r.interest || '-'}</td>
                <td style="color:var(--primary); font-weight:600;">${r.appt || '<span style="color:var(--danger)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>'}</td>
                <td>${r.sale || '-'}</td>
                <td><span class="badge bg-wait">${r.note || 'P2'}</span></td>
            </tr>
        `).join('');

        updateChart(p1Conv, upP2Conv, none);
    }

    function updateChart(p1, up, none) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['‡πÄ‡∏õ‡πá‡∏ô P1', '‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î UP P2', '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°'],
                datasets: [{ data: [p1, up, none], backgroundColor: ['#198754', '#ffc107', '#adb5bd'] }]
            },
            options: { maintainAspectRatio: false, cutout: '70%' }
        });
    }
</script>
</body>
</html>
