<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2 Sales Dashboard (Data Sync Fixed)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0d6efd;
            --success: #198754;
            --warning: #ffc107;
            --purple: #6610f2;
            --gray: #6c757d;
            --light: #f8f9fa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Kanit', sans-serif; }
        body { background-color: #f4f7f6; color: #333; line-height: 1.6; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .header { 
            background: linear-gradient(135deg, var(--primary) 0%, #0dcaf0 100%); 
            color: white; padding: 30px 20px; border-radius: 15px;
            text-align: center; margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.2);
        }

        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #edf2f7; margin-bottom: 20px; overflow: hidden; }
        .controls-section { padding: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between; }
        .filter-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        select, input { padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: #e2e8f0; color: #4a5568; }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; border-bottom: 4px solid var(--primary); }
        .kpi-card.p2 { border-color: var(--primary); }
        .kpi-card.up-p2-total { border-color: var(--purple); }
        .kpi-card.p1-conv { border-color: var(--success); }
        .kpi-card.up-p2-conv { border-color: var(--warning); }
        
        .kpi-label { color: var(--gray); font-size: 13px; font-weight: 500; text-transform: uppercase; margin-bottom: 10px; }
        .kpi-value { font-size: 32px; font-weight: 700; color: #1a202c; display: flex; align-items: baseline; gap: 5px; }
        .kpi-sub { font-size: 14px; color: var(--success); font-weight: 500; }

        .main-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 25px; }
        @media (max-width: 992px) { .main-layout { grid-template-columns: 1fr; } }

        .chart-container { height: 350px; padding: 20px; }
        .table-container { height: 400px; overflow-y: auto; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8fafc; padding: 12px 15px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 1; border-bottom: 1px solid #e2e8f0; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; }
        
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .bg-success { background: #dcfce7; color: #166534; }
        .bg-warning { background: #fef9c3; color: #854d0e; }
        .bg-purple { background: #f3e8ff; color: #581c87; }

        #statusText { padding: 10px; font-size: 14px; border-radius: 8px; text-align: center; display: none; margin-bottom: 15px; }
        .status-loading { display: block !important; background: #e0f2fe; color: #0369a1; }
        .status-error { display: block !important; background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Sales & Conversion Dashboard (P2 Focus)</h1>
        <p>Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö UP P2 ‡πÅ‡∏•‡∏∞ Missing Phone)</p>
    </div>

    <div class="card">
        <div class="controls-section">
            <div class="filter-group">
                <select id="branchSelector">
                    <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                    <option value="Choc">Choc (FRC)</option>
                    <option value="Bangyai">Bangyai (FRB)</option>
                    <option value="Sriracha">Sriracha (FRS)</option>
                    <option value="Ram">Ram (FRR)</option>
                    <option value="Bornsong">BSK</option>
                </select>
                <button class="btn btn-primary" onclick="loadData()">üîÑ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
            <div class="filter-group">
                <input type="date" id="startDate">
                <span>‡∏ñ‡∏∂‡∏á</span>
                <input type="date" id="endDate">
                <button class="btn btn-success" id="filterBtn" onclick="processData()" disabled>üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button class="btn btn-secondary" onclick="resetFilters()">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
        </div>
    </div>

    <div id="statusText"></div>

    <div id="dashboard" style="display:none;">
        <div class="kpi-grid">
            <div class="kpi-card p2">
                <div class="kpi-label">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ P2</div>
                <div class="kpi-value" id="kpi-total-p2">0</div>
            </div>
            <div class="kpi-card up-p2-total">
                <div class="kpi-label">üíú ‡∏ö‡∏¥‡∏• UP P2 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="kpi-value" id="kpi-all-up-p2">0</div>
            </div>
            <div class="kpi-card p1-conv">
                <div class="kpi-label">‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô P1</div>
                <div class="kpi-value">
                    <span id="kpi-conv-p1">0</span>
                    <span class="kpi-sub" id="perc-p1">0%</span>
                </div>
            </div>
            <div class="kpi-card up-p2-conv">
                <div class="kpi-label">‚ö†Ô∏è UP P2 (‡∏à‡∏≤‡∏Å P2)</div>
                <div class="kpi-value">
                    <span id="kpi-conv-up">0</span>
                    <span class="kpi-sub" id="perc-up" style="color:var(--warning)">0%</span>
                </div>
            </div>
        </div>

        <div class="main-layout">
            <div class="card">
                <div class="chart-container">
                    <h3 style="margin-bottom:15px; text-align:center; font-size:16px;">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô Conversion ‡∏à‡∏≤‡∏Å P2</h3>
                    <canvas id="convChart"></canvas>
                </div>
            </div>
            <div class="card">
                <div style="padding:15px; border-bottom:1px solid #eee;">
                    <h3 style="font-size:16px;">üèÜ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ UP P2 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                </div>
                <div class="table-container">
                    <table id="successTable">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                                <th>Sale</th>
                            </tr>
                        </thead>
                        <tbody id="successBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="font-size:16px; color:#e53e3e;">üö© ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ P2 ‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°)</h3>
                <span id="pendingCount" class="badge bg-purple" style="font-size:14px;">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <div class="table-container" style="height:400px;">
                <table id="pendingTable">
                    <thead>
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà P2</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
                            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</th>
                            <th>Sale</th>
                            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                    </thead>
                    <tbody id="pendingBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const SHEETS = {
        'Choc': '1F2bTvP1ySUT1q6fzRPQu7UpKNW_ze8GtKkd2rmRUjkI',
        'Bangyai': '1JU-rhoWIEHH4oSwIWApo8mUC8zQpNcT0Xd-70E_6CNM',
        'Sriracha': '1PdYqXkrrRGIv-6cCgOn8VXE6MpQhMlBGpFw7BbfzFbI',
        'Ram': '1LFoETe4YdPIxxj27bXxNRip9dKJ-sL7bbDv820ExEtk',
        'Bornsong': '1dlgM7YaQmJQTuiuNdAMb6tjKHllPgIs8MjfgGZnp8jU'
    };

    let rawData = [];
    let chartInstance = null;

    // Helper: Find value with flexible keys
    function getValFlexible(row, keywords) {
        for (let key in row) {
            const cleanKey = key.trim().toLowerCase().replace(/\s+/g, '');
            for (let kw of keywords) {
                const cleanKw = kw.toLowerCase().replace(/\s+/g, '');
                if (cleanKey === cleanKw || cleanKey.includes(cleanKw)) return row[key];
            }
        }
        return '';
    }

    // Helper: Parse Date (Thai Year and ISO format support)
    function robustParseDate(s) {
        if (!s) return null;
        s = s.trim();
        let d, m, y;
        if (s.includes('-')) {
            const p = s.split('-');
            if (p[0].length === 4) { // YYYY-MM-DD
                y = parseInt(p[0]); m = parseInt(p[1]); d = parseInt(p[2]);
            } else { // DD-MM-YYYY
                d = parseInt(p[0]); m = parseInt(p[1]); y = parseInt(p[2]);
            }
        } else if (s.includes('/')) {
            const p = s.split('/');
            d = parseInt(p[0]); m = parseInt(p[1]); y = parseInt(p[2]);
        } else { return null; }

        if (y > 2500) y -= 543; // Correct Thai BE Year
        if (y < 100) y += 2000;
        return new Date(y, m - 1, d);
    }

    // Helper: Clean Numeric values
    function cleanNumeric(val) {
        if (!val) return 0;
        const cleaned = val.toString().replace(/[^\d.-]/g, '');
        return parseFloat(cleaned) || 0;
    }

    // Helper: Normalize Name for matching
    function normalizeName(name) {
        if (!name) return '';
        return name.replace(/^‡∏Ñ‡∏∏‡∏ì/, '').trim().replace(/\s+/g, '');
    }

    async function loadData() {
        const branch = document.getElementById('branchSelector').value;
        const status = document.getElementById('statusText');
        if(!branch) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤");

        status.innerHTML = "‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...";
        status.className = "status-loading";

        try {
            const id = SHEETS[branch];
            const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv`;
            const resp = await fetch(url);
            const text = await resp.text();
            
            rawData = parseCSV(text);
            status.innerHTML = `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${rawData.length} ‡πÅ‡∏ñ‡∏ß`;
            document.getElementById('filterBtn').disabled = false;
            document.getElementById('dashboard').style.display = 'block';

            // Default dates
            const now = new Date();
            document.getElementById('startDate').valueAsDate = new Date(now.getFullYear(), now.getMonth(), 1);
            document.getElementById('endDate').valueAsDate = now;

            processData();
        } catch (e) {
            status.innerHTML = "‚ùå Error: " + e.message;
            status.className = "status-error";
        }
    }

    function parseCSV(text) {
        const lines = text.split('\n');
        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
        return lines.slice(1).map(line => {
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const obj = {};
            headers.forEach((h, i) => {
                obj[h] = values[i] ? values[i].replace(/"/g, '').trim() : '';
            });
            return obj;
        });
    }

    function processData() {
        const start = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : null;
        const end = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : null;
        if(start) start.setHours(0,0,0,0);
        if(end) end.setHours(23,59,59,999);

        const usersByPhone = {}; 
        const usersByName = {}; 
        
        let p2Targets = 0;
        let p1Converted = 0;
        let upP2Converted = 0;
        let allUpP2Bills = 0;
        let successList = [];
        let pendingList = [];

        // 1. Pre-process and Group Data
        rawData.forEach(row => {
            const date = robustParseDate(getValFlexible(row, ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'date']));
            if (!date) return;

            const name = getValFlexible(row, ['‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠']).trim();
            const phone = getValFlexible(row, ['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£', 'phone']).trim();
            const note = getValFlexible(row, ['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', 'note']).toUpperCase();
            
            const upP2Amt = cleanNumeric(getValFlexible(row, ['‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏ûP2', '‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û P2', 'UpP2']));
            const upP1Amt = cleanNumeric(getValFlexible(row, ['‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏ûP1', '‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û P1', 'UpP1']));
            const p1Flag = getValFlexible(row, ['P1', '‡∏¢‡∏≠‡∏î‡∏à‡∏≠‡∏á']).trim();
            const p2Flag = getValFlexible(row, ['P2']).trim();

            const entry = {
                ...row,
                _date: date,
                _name: name,
                _normName: normalizeName(name),
                _phone: phone,
                _note: note,
                _upP2Amt: upP2Amt,
                _upP1Amt: upP1Amt,
                _p1: p1Flag,
                _p2: p2Flag
            };

            // Index by phone (if available)
            if (phone && phone.length > 5) {
                if (!usersByPhone[phone]) usersByPhone[phone] = [];
                usersByPhone[phone].push(entry);
            }
            // Index by Normalized Name
            if (entry._normName) {
                if (!usersByName[entry._normName]) usersByName[entry._normName] = [];
                usersByName[entry._normName].push(entry);
            }
        });

        // Track used IDs to avoid double counting conversion
        const convertedUserIds = new Set();

        // 2. Main Logic
        // Loop through all data to find P2 targets within range and total UP P2 bills
        rawData.forEach(row => {
            // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å pre-process ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏∞‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏ô‡∏ã‡πâ‡∏≥ rawData ‡∏ï‡∏£‡∏á‡πÜ)
            // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£ normalize ‡πÅ‡∏•‡πâ‡∏ß
        });

        // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Phone based first, then name based)
        const allUserLogs = [];
        for(let p in usersByPhone) allUserLogs.push(usersByPhone[p].sort((a,b)=>a._date-b._date));
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô (KPI ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á)
        rawData.forEach(row => {
            const d = robustParseDate(getValFlexible(row, ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));
            if (!d || d < start || d > end) return;
            
            const note = getValFlexible(row, ['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']).toUpperCase();
            const upP2 = cleanNumeric(getValFlexible(row, ['‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û P2', '‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏ûP2']));
            
            if (upP2 > 0 || note.includes('UP P2') || note.includes('UPP2')) {
                allUpP2Bills++;
                successList.push({
                    date: d,
                    name: getValFlexible(row, ['‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤']),
                    amt: upP2,
                    sale: getValFlexible(row, ['Sale', '‡πÄ‡∏ã‡∏•‡∏•‡πå'])
                });
            }
        });

        // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Conversion
        const processedP2Keys = new Set();

        for (let uid in usersByPhone) {
            const logs = usersByPhone[uid].sort((a,b) => a._date - b._date);
            processLogs(logs);
        }

        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£)
        for (let name in usersByName) {
            const logs = usersByName[name];
            const hasPhone = logs.some(l => l._phone && l._phone.length > 5);
            if (hasPhone) continue; // Skip because already processed in usersByPhone
            processLogs(logs.sort((a,b) => a._date - b._date));
        }

        function processLogs(logs) {
            logs.forEach((log, idx) => {
                const isP2 = (log._p2 !== '' || log._note === 'P2') && !log._note.includes('UP');
                const inRange = log._date >= start && log._date <= end;
                
                if (isP2 && inRange) {
                    const key = (log._phone || log._normName) + log._date.getTime();
                    if (processedP2Keys.has(key)) return;
                    processedP2Keys.add(key);
                    
                    p2Targets++;
                    let converted = false;
                    
                    // Look forward for conversion
                    for (let i = idx; i < logs.length; i++) {
                        const n = logs[i];
                        if (n._upP1Amt > 0 || n._p1 !== '' || n._note.includes('P1')) {
                            p1Converted++; converted = true; break;
                        } else if (n._upP2Amt > 0 || n._note.includes('UP P2') || n._note.includes('UPP2')) {
                            upP2Converted++; converted = true; break;
                        }
                    }

                    if (!converted) {
                        pendingList.push({
                            date: log._date,
                            name: log._name,
                            phone: log._phone,
                            interest: getValFlexible(log, ['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à']),
                            sale: getValFlexible(log, ['Sale']),
                            status: log._note || 'P2'
                        });
                    }
                }
            });
        }

        // Update UI
        document.getElementById('kpi-total-p2').innerText = p2Targets;
        document.getElementById('kpi-all-up-p2').innerText = allUpP2Bills;
        document.getElementById('kpi-conv-p1').innerText = p1Converted;
        document.getElementById('kpi-conv-up').innerText = upP2Converted;

        const perc = (v) => p2Targets > 0 ? ((v/p2Targets)*100).toFixed(1) + '%' : '0%';
        document.getElementById('perc-p1').innerText = perc(p1Converted);
        document.getElementById('perc-up').innerText = perc(upP2Converted);

        updateTable('successBody', successList, r => `
            <tr>
                <td>${r.date.toLocaleDateString('th-TH')}</td>
                <td><b>${r.name}</b></td>
                <td style="color:var(--purple); font-weight:600;">${r.amt.toLocaleString()}</td>
                <td>${r.sale}</td>
            </tr>
        `);

        updateTable('pendingBody', pendingList, r => `
            <tr>
                <td>${r.date.toLocaleDateString('th-TH')}</td>
                <td><b>${r.name}</b></td>
                <td>${r.phone || '-'}</td>
                <td style="font-size:12px; color:var(--gray);">${r.interest || '-'}</td>
                <td>${r.sale}</td>
                <td><span class="badge" style="background:#eee; color:#666;">${r.status}</span></td>
            </tr>
        `);
        document.getElementById('pendingCount').innerText = `${pendingList.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

        updateChart(p1Converted, upP2Converted, Math.max(0, p2Targets - p1Converted - upP2Converted));
    }

    function updateTable(id, data, formatter) {
        const el = document.getElementById(id);
        if (id === 'successBody') data.sort((a,b) => b.date - a.date);
        el.innerHTML = data.length ? data.map(formatter).join('') : '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    }

    function updateChart(p1, up, none) {
        const ctx = document.getElementById('convChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['‡πÄ‡∏õ‡πá‡∏ô P1', 'Upgrade P2', '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°'],
                datasets: [{
                    data: [p1, up, none],
                    backgroundColor: ['#198754', '#ffc107', '#cbd5e1'],
                    borderWidth: 0
                }]
            },
            options: { maintainAspectRatio: false, cutout: '75%' }
        });
    }

    function resetFilters() {
        document.getElementById('branchSelector').selectedIndex = 0;
        document.getElementById('dashboard').style.display = 'none';
    }
</script>
</body>
</html>
