<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2 Sales Dashboard (P1 Column I Focus)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0d6efd;
            --success: #198754;
            --warning: #ffc107;
            --purple: #6610f2;
            --gray: #6c757d;
            --light: #f8f9fa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Kanit', sans-serif; }
        body { background-color: #f4f7f6; color: #333; line-height: 1.6; }
        
        .container { max-width: 1500px; margin: 0 auto; padding: 20px; }

        .header { 
            background: linear-gradient(135deg, var(--primary) 0%, #0dcaf0 100%); 
            color: white; padding: 30px 20px; border-radius: 15px;
            text-align: center; margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.2);
        }

        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #edf2f7; margin-bottom: 20px; overflow: hidden; }
        .controls-section { padding: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between; }
        .filter-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        select, input { padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: #e2e8f0; color: #4a5568; }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; border-bottom: 4px solid var(--primary); }
        .kpi-card.p2 { border-color: var(--primary); }
        .kpi-card.up-p2-total { border-color: var(--purple); }
        .kpi-card.p1-conv { border-color: var(--success); }
        .kpi-card.up-p2-conv { border-color: var(--warning); }
        
        .kpi-label { color: var(--gray); font-size: 13px; font-weight: 500; text-transform: uppercase; margin-bottom: 10px; line-height: 1.2; height: 32px; display: flex; align-items: center; }
        .kpi-value { font-size: 32px; font-weight: 700; color: #1a202c; display: flex; align-items: baseline; gap: 5px; }
        .kpi-sub { font-size: 14px; color: var(--success); font-weight: 500; }

        .main-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 25px; }
        @media (max-width: 992px) { .main-layout { grid-template-columns: 1fr; } }

        .chart-container { height: 350px; padding: 20px; }
        .table-container { height: 400px; overflow-y: auto; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8fafc; padding: 12px 15px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 1; border-bottom: 1px solid #e2e8f0; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; }
        
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .bg-success { background: #dcfce7; color: #166534; }
        .bg-warning { background: #fef9c3; color: #854d0e; }
        .bg-purple { background: #f3e8ff; color: #581c87; }

        #statusText { padding: 10px; font-size: 14px; border-radius: 8px; text-align: center; display: none; margin-bottom: 15px; }
        .status-loading { display: block !important; background: #e0f2fe; color: #0369a1; }
        .status-error { display: block !important; background: #fee2e2; color: #991b1b; }

        .table-section-title { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .table-section-title h3 { font-size: 16px; margin: 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Sales & Conversion Dashboard (P2 Focus)</h1>
        <p>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ P2 ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞ P1 (‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≠‡∏á I)</p>
    </div>

    <div class="card">
        <div class="controls-section">
            <div class="filter-group">
                <select id="branchSelector">
                    <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                    <option value="Choc">Choc (FRC)</option>
                    <option value="Bangyai">Bangyai (FRB)</option>
                    <option value="Sriracha">Sriracha (FRS)</option>
                    <option value="Ram">Ram (FRR)</option>
                    <option value="Bornsong">BSK</option>
                </select>
                <button class="btn btn-primary" onclick="loadData()">üîÑ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
            <div class="filter-group">
                <input type="date" id="startDate">
                <span>‡∏ñ‡∏∂‡∏á</span>
                <input type="date" id="endDate">
                <button class="btn btn-success" id="filterBtn" onclick="processData()" disabled>üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button class="btn btn-secondary" onclick="resetFilters()">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
        </div>
    </div>

    <div id="statusText"></div>

    <div id="dashboard" style="display:none;">
        <div class="kpi-grid">
            <div class="kpi-card p2">
                <div class="kpi-label">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ P2</div>
                <div class="kpi-value" id="kpi-total-p2">0</div>
            </div>
            <div class="kpi-card up-p2-total">
                <div class="kpi-label">üíú ‡∏ö‡∏¥‡∏• UP P2 ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
                <div class="kpi-value" id="kpi-all-up-p2">0</div>
            </div>
            <div class="kpi-card p1-conv">
                <div class="kpi-label">‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô P1 (‡∏ä‡πà‡∏≠‡∏á I)</div>
                <div class="kpi-value">
                    <span id="kpi-conv-p1">0</span>
                    <span class="kpi-sub" id="perc-p1">0%</span>
                </div>
            </div>
            <div class="kpi-card up-p2-conv">
                <div class="kpi-label">‚ö†Ô∏è UP P2 ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="kpi-value">
                    <span id="kpi-conv-up">0</span>
                    <span class="kpi-sub" id="perc-up" style="color:var(--warning)">0%</span>
                </div>
            </div>
        </div>

        <div class="main-layout">
            <div class="card">
                <div class="chart-container">
                    <h3 style="margin-bottom:15px; text-align:center; font-size:16px;">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô P2</h3>
                    <canvas id="convChart"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="table-section-title">
                    <h3 style="color: var(--purple);">üíú ‡∏ö‡∏¥‡∏• UP P2 ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h3>
                </div>
                <div class="table-container">
                    <table id="upP2Table">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                                <th>Sale</th>
                            </tr>
                        </thead>
                        <tbody id="upP2Body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="table-section-title">
                <h3 style="color: var(--success);">üèÜ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ P1 (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ P2 ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô P1 ‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á I)</h3>
            </div>
            <div class="table-container" style="height: 400px;">
                <table id="p1Table">
                    <thead>
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà P1</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞ P1 (‡∏ä‡πà‡∏≠‡∏á I)</th>
                            <th>Sale</th>
                        </tr>
                    </thead>
                    <tbody id="p1Body"></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div style="padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="font-size:16px; color:#e53e3e;">üö© ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ P2 ‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°)</h3>
                <span id="pendingCount" class="badge bg-purple" style="font-size:14px;">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <div class="table-container" style="height:400px;">
                <table id="pendingTable">
                    <thead>
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà P2</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
                            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</th>
                            <th style="color: var(--primary);">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                            <th>Sale</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="pendingBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const SHEETS = {
        'Choc': '1F2bTvP1ySUT1q6fzRPQu7UpKNW_ze8GtKkd2rmRUjkI',
        'Bangyai': '1JU-rhoWIEHH4oSwIWApo8mUC8zQpNcT0Xd-70E_6CNM',
        'Sriracha': '1PdYqXkrrRGIv-6cCgOn8VXE6MpQhMlBGpFw7BbfzFbI',
        'Ram': '1LFoETe4YdPIxxj27bXxNRip9dKJ-sL7bbDv820ExEtk',
        'Bornsong': '1dlgM7YaQmJQTuiuNdAMb6tjKHllPgIs8MjfgGZnp8jU'
    };

    let rawData = [];
    let chartInstance = null;

    function getValFlexible(row, keywords) {
        for (let key in row) {
            const cleanKey = key.trim().toLowerCase().replace(/\s+/g, '');
            for (let kw of keywords) {
                const cleanKw = kw.toLowerCase().replace(/\s+/g, '');
                if (cleanKey === cleanKw || cleanKey.includes(cleanKw)) return row[key];
            }
        }
        return '';
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Column I (Index 8 ‡πÉ‡∏ô CSV ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ Header ‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤)
    function getP1Value(row) {
        // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô
        const val = getValFlexible(row, ['P1', '‡∏¢‡∏≠‡∏î‡∏à‡∏≠‡∏á']);
        if (val !== '') return cleanNumeric(val);
        
        // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Index 8 (Column I)
        const keys = Object.keys(row);
        if (keys.length > 8) {
            return cleanNumeric(row[keys[8]]);
        }
        return 0;
    }

    function robustParseDate(s) {
        if (!s) return null;
        s = s.trim();
        let parts = s.split(/[\-\/]/);
        if (parts.length < 3) return null;

        let p1 = parseInt(parts[0]);
        let p2 = parseInt(parts[1]);
        let p3 = parseInt(parts[2]);
        let d, m, y;

        if (p1 > 1000) { 
            y = p1; m = p2; d = p3;
        } else if (p1 > 12) {
            d = p1; m = p2; y = p3;
        } else if (p2 > 12) {
            m = p1; d = p2; y = p3;
        } else {
            d = p1; m = p2; y = p3;
        }

        if (y > 2500) y -= 543;
        if (y < 100) y += 2000;
        
        const dt = new Date(y, m - 1, d);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function cleanNumeric(val) {
        if (!val) return 0;
        const cleaned = val.toString().replace(/[^\d.-]/g, '');
        return parseFloat(cleaned) || 0;
    }

    function normalizeName(name) {
        if (!name) return '';
        return name.replace(/^‡∏Ñ‡∏∏‡∏ì/, '').trim().replace(/\s+/g, '');
    }

    async function loadData() {
        const branch = document.getElementById('branchSelector').value;
        const status = document.getElementById('statusText');
        if(!branch) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤");

        status.innerHTML = "‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...";
        status.className = "status-loading";

        try {
            const id = SHEETS[branch];
            const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv`;
            const resp = await fetch(url);
            const text = await resp.text();
            
            rawData = parseCSV(text);
            status.innerHTML = `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${rawData.length} ‡πÅ‡∏ñ‡∏ß`;
            document.getElementById('filterBtn').disabled = false;
            document.getElementById('dashboard').style.display = 'block';

            const now = new Date();
            document.getElementById('startDate').valueAsDate = new Date(now.getFullYear(), now.getMonth(), 1);
            document.getElementById('endDate').valueAsDate = now;

            processData();
        } catch (e) {
            status.innerHTML = "‚ùå Error: " + e.message;
            status.className = "status-error";
        }
    }

    function parseCSV(text) {
        const lines = text.split('\n');
        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
        return lines.slice(1).map(line => {
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const obj = {};
            headers.forEach((h, i) => {
                obj[h] = values[i] ? values[i].replace(/"/g, '').trim() : '';
            });
            return obj;
        });
    }

    function processData() {
        const start = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : null;
        const end = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : null;
        if(start) start.setHours(0,0,0,0);
        if(end) end.setHours(23,59,59,999);

        const usersByPhone = {}; 
        const usersByName = {}; 
        
        let p2Targets = 0;
        let p1ConvertedCount = 0;
        let upP2ConvertedCount = 0;
        let allUpP2BillsTotal = 0;
        
        let upP2DisplayList = [];
        let p1DisplayList = [];
        let pendingDisplayList = [];

        // Pre-process and index data
        rawData.forEach(row => {
            const date = robustParseDate(getValFlexible(row, ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'date']));
            if (!date) return;

            const name = getValFlexible(row, ['‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠']).trim();
            const phone = getValFlexible(row, ['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£', 'phone']).trim();
            const note = getValFlexible(row, ['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', 'note']).toUpperCase();
            
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ P1 ‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á I (Index 8)
            const p1Amt = getP1Value(row);
            const upP2Amt = cleanNumeric(getValFlexible(row, ['‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏ûP2', '‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û P2']));

            const entry = {
                ...row,
                _date: date,
                _name: name,
                _normName: normalizeName(name),
                _phone: phone,
                _note: note,
                _p1Amt: p1Amt,
                _upP2Amt: upP2Amt,
                _isP2: getValFlexible(row, ['P2']).trim() !== '' || (note === 'P2'),
                _serviceDate: getValFlexible(row, ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', '‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤'])
            };

            if (phone && phone.length > 5) {
                if (!usersByPhone[phone]) usersByPhone[phone] = [];
                usersByPhone[phone].push(entry);
            }
            if (entry._normName) {
                if (!usersByName[entry._normName]) usersByName[entry._normName] = [];
                usersByName[entry._normName].push(entry);
            }
        });

        // Loop for UP P2 Volume
        rawData.forEach(row => {
            const d = robustParseDate(getValFlexible(row, ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));
            if (!d || d < start || d > end) return;
            
            const note = getValFlexible(row, ['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', 'note']).toUpperCase();
            const upP2AmtValue = cleanNumeric(getValFlexible(row, ['‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û P2', '‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏ûP2']));

            if (upP2AmtValue > 0 || note.includes('UP P2')) {
                allUpP2BillsTotal++;
                upP2DisplayList.push({
                    date: d,
                    name: getValFlexible(row, ['‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤']),
                    interest: getValFlexible(row, ['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à']),
                    amt: upP2AmtValue,
                    sale: getValFlexible(row, ['Sale', '‡πÄ‡∏ã‡∏•‡∏•‡πå'])
                });
            }
        });

        const processedP2Keys = new Set();
        
        const processLogs = (logs) => {
            logs.forEach((log, idx) => {
                const isP2Entry = log._isP2 && !log._note.includes('UP');
                const inRange = log._date >= start && log._date <= end;
                
                if (isP2Entry && inRange) {
                    const key = (log._phone || log._normName) + log._date.getTime();
                    if (processedP2Keys.has(key)) return;
                    processedP2Keys.add(key);
                    
                    p2Targets++;
                    let converted = false;
                    
                    for (let i = idx; i < logs.length; i++) {
                        const n = logs[i];
                        
                        // ‡πÄ‡∏Ñ‡∏™‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô P1 (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á I ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà UP P1)
                        const isRealP1 = n._p1Amt > 0 && !n._note.includes('UP P1');
                        const isUpP2 = n._upP2Amt > 0 || n._note.includes('UP P2');

                        if (isRealP1) {
                            p1ConvertedCount++; 
                            converted = true;
                            p1DisplayList.push({
                                date: n._date,
                                name: n._name,
                                interest: getValFlexible(n, ['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à']),
                                amt: n._p1Amt,
                                sale: getValFlexible(n, ['Sale', '‡πÄ‡∏ã‡∏•‡∏•‡πå'])
                            });
                            break;
                        } 
                        else if (isUpP2) {
                            upP2ConvertedCount++; converted = true; 
                            break;
                        }
                    }

                    if (!converted) {
                        pendingDisplayList.push({
                            date: log._date,
                            name: log._name,
                            phone: log._phone,
                            interest: getValFlexible(log, ['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à']),
                            serviceDate: log._serviceDate,
                            sale: getValFlexible(log, ['Sale']),
                            status: log._note || 'P2'
                        });
                    }
                }
            });
        };

        for(let p in usersByPhone) processLogs(usersByPhone[p].sort((a,b)=>a._date-b._date));
        for (let name in usersByName) {
            const logs = usersByName[name];
            if (!logs.some(l => l._phone && l._phone.length > 5)) {
                processLogs(logs.sort((a,b) => a._date - b._date));
            }
        }

        document.getElementById('kpi-total-p2').innerText = p2Targets;
        document.getElementById('kpi-all-up-p2').innerText = allUpP2BillsTotal;
        document.getElementById('kpi-conv-p1').innerText = p1ConvertedCount;
        document.getElementById('kpi-conv-up').innerText = upP2ConvertedCount;

        const calcPerc = (v) => p2Targets > 0 ? ((v/p2Targets)*100).toFixed(1) + '%' : '0%';
        document.getElementById('perc-p1').innerText = calcPerc(p1ConvertedCount);
        document.getElementById('perc-up').innerText = calcPerc(upP2ConvertedCount);

        updateTable('upP2Body', upP2DisplayList, r => `
            <tr>
                <td>${r.date.toLocaleDateString('th-TH')}</td>
                <td><b>${r.name}</b></td>
                <td style="font-size:12px; color:#555;">${r.interest || '-'}</td>
                <td style="color:var(--purple); font-weight:600;">${r.amt.toLocaleString()}</td>
                <td>${r.sale}</td>
            </tr>
        `);

        updateTable('p1Body', p1DisplayList, r => `
            <tr>
                <td>${r.date.toLocaleDateString('th-TH')}</td>
                <td><b>${r.name}</b></td>
                <td style="font-size:12px; color:#555;">${r.interest || '-'}</td>
                <td style="color:var(--success); font-weight:600;">${r.amt.toLocaleString()}</td>
                <td>${r.sale}</td>
            </tr>
        `);

        updateTable('pendingBody', pendingDisplayList, r => `
            <tr>
                <td>${r.date.toLocaleDateString('th-TH')}</td>
                <td><b>${r.name}</b></td>
                <td>${r.phone || '-'}</td>
                <td style="font-size:12px; color:var(--gray);">${r.interest || '-'}</td>
                <td style="color:var(--primary); font-weight:500;">${r.serviceDate || '-'}</td>
                <td>${r.sale}</td>
                <td><span class="badge" style="background:#eee; color:#666;">${r.status}</span></td>
            </tr>
        `);

        document.getElementById('pendingCount').innerText = `${pendingDisplayList.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        updateChart(p1ConvertedCount, upP2ConvertedCount, Math.max(0, p2Targets - p1ConvertedCount - upP2ConvertedCount));
    }

    function updateTable(id, data, formatter) {
        const el = document.getElementById(id);
        data.sort((a,b) => b.date - a.date);
        el.innerHTML = data.length ? data.map(formatter).join('') : '<tr><td colspan="7" style="text-align:center; padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</td></tr>';
    }

    function updateChart(p1, up, none) {
        const ctx = document.getElementById('convChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['‡πÄ‡∏õ‡πá‡∏ô P1', 'Upgrade P2', '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°'],
                datasets: [{
                    data: [p1, up, none],
                    backgroundColor: ['#198754', '#ffc107', '#cbd5e1'],
                    borderWidth: 0
                }]
            },
            options: { maintainAspectRatio: false, cutout: '75%' }
        });
    }

    function resetFilters() {
        document.getElementById('branchSelector').selectedIndex = 0;
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('statusText').style.display = 'none';
    }
</script>
</body>
</html>
