<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2 Dashboard + Tracking System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Kanit', sans-serif; }
        body { background-color: #f0f2f5; padding: 20px; color: #1a1a1a; font-size: 14px; }
        
        /* Container Adjustment */
        .container { max-width: 1500px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        
        .header { background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%); color: white; padding: 25px 20px; text-align: center; }
        .header h1 { margin-bottom: 5px; font-size: 24px; }
        .header p { opacity: 0.9; font-weight: 300; }

        /* Controls Section */
        .controls-section { padding: 20px; background: #fff; border-bottom: 1px solid #eee; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: center; }
        .filter-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center; }
        
        select, input[type="date"] { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; outline: none; }
        select:focus, input:focus { border-color: #0d6efd; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center; white-space: nowrap; }
        .btn-primary { background: #0d6efd; color: white; }
        .btn-success { background: #198754; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }

        /* KPI Grid */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; }
        
        .kpi-card { background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #0d6efd; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
        .kpi-card.total-up { border-color: #6610f2; }
        .kpi-card.p1 { border-color: #198754; }
        .kpi-card.up-p2 { border-color: #ffc107; }
        .kpi-card.unconverted { border-color: #adb5bd; }
        
        .kpi-title { color: #6c757d; font-size: 13px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 28px; font-weight: 700; margin-bottom: 2px; line-height: 1.2; }
        .kpi-percent { font-size: 14px; font-weight: 500; color: #198754; }

        /* Content Layout */
        .content-layout { display: flex; flex-wrap: wrap; padding: 0 20px 20px; gap: 20px; }
        .chart-box { flex: 1 1 350px; background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; height: 400px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .table-box { flex: 2 1 500px; background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; height: 400px; display: flex; flex-direction: column; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .full-width-section { width: 100%; padding: 0 20px 20px; }

        /* Table Styling */
        .table-container { overflow-x: auto; margin-top: 15px; border-radius: 8px; border: 1px solid #eee; flex-grow: 1; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 800px; }
        th { background: #f8f9fa; padding: 12px 15px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #ddd; white-space: nowrap; }
        td { padding: 10px 15px; border-bottom: 1px solid #f1f1f1; vertical-align: middle; }
        
        tfoot { background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6; }
        tfoot td { color: #000; padding: 12px 15px; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; white-space: nowrap; display: inline-block; }
        .bg-total-up { background: #e0cffc; color: #3d0a91; }
        
        #statusMessage { font-size: 14px; font-weight: 500; width: 100%; text-align: center; margin-top: 10px; }
        .error { color: #dc3545; }
        .success { color: #198754; }
        
        /* New Tracking Inputs Styles */
        .track-checkbox-group { display: flex; gap: 10px; align-items: center; }
        .track-checkbox-label { display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer; padding: 4px 8px; border-radius: 4px; background: #f8f9fa; border: 1px solid #eee; user-select: none; }
        .track-checkbox-label:hover { background: #e9ecef; }
        .track-checkbox-label input { margin: 0; cursor: pointer; }
        
        /* Highlight active states */
        .track-checkbox-label.is-checked-call { background: #cfe2ff; color: #084298; border-color: #b6d4fe; }
        .track-checkbox-label.is-checked-enter { background: #d1e7dd; color: #0f5132; border-color: #badbcc; }

        .track-note-input { width: 100%; padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; transition: border-color 0.2s; }
        .track-note-input:focus { border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header h1 { font-size: 20px; }
            .controls-section, .filter-group { flex-direction: column; align-items: stretch; }
            .filter-group span { display: none; }
            select, input, .btn { width: 100%; }
            .dashboard-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .chart-box, .table-box { flex: 1 1 100%; height: auto; }
            .table-container { max-height: 500px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Sales & Conversion (UP P2 Focus)</h1>
        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Real-time</p>
    </div>

    <div class="controls-section">
        <div class="filter-group">
            <select id="branchSelector">
                <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                <option value="Choc">Choc (‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà)</option>
                <option value="Bangyai">Bangyai (‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø)</option>
                <option value="Sriracha">Sriracha (‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ)</option>
                <option value="Ram">Ram (‡∏£‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤)</option>
                <option value="Bornsong">Bornsong</option>
            </select>
            <button class="btn btn-primary" onclick="fetchAndProcessData()" id="loadBtn">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <div class="filter-group">
            <input type="date" id="startDate">
            <span>‡∏ñ‡∏∂‡∏á</span>
            <input type="date" id="endDate">
            <button class="btn btn-success" onclick="applyFiltersAndAnalyze()" id="filterBtn" disabled>üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button class="btn btn-secondary" onclick="clearFilters()" id="clearBtn" disabled>‡∏•‡πâ‡∏≤‡∏á</button>
        </div>
        <div id="statusMessage"></div>
    </div>

    <div id="dashboardContent" style="display: none;">
        <div class="dashboard-grid">
            <div class="kpi-card">
                <div class="kpi-title">üéØ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ P2</div>
                <div class="kpi-value" id="totalP2">0</div>
            </div>
            <div class="kpi-card total-up">
                <div class="kpi-title">üíú ‡∏ö‡∏¥‡∏• UP P2 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="kpi-value" id="totalAllUpP2">0</div>
            </div>
            <div class="kpi-card p1">
                <div class="kpi-title">‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô P1</div>
                <div class="kpi-value" id="countP1">0</div>
                <div class="kpi-percent" id="percP1">0%</div>
            </div>
            <div class="kpi-card up-p2">
                <div class="kpi-title">‚ö†Ô∏è Upgrade UP P2</div>
                <div class="kpi-value" id="countUpP2">0</div>
                <div class="kpi-percent" id="percUpP2">0%</div>
            </div>
            <div class="kpi-card unconverted">
                <div class="kpi-title">‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</div>
                <div class="kpi-value" id="countNone">0</div>
                <div class="kpi-percent" style="color:#6c757d" id="percNone">0%</div>
            </div>
        </div>

        <div class="content-layout">
            <div class="chart-box">
                <h3 style="text-align:center; margin-bottom:15px;">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏à‡∏≤‡∏Å P2)</h3>
                <div style="position: relative; height: 85%;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
            <div class="table-box">
                <h3>üèÜ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ UP P2 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <div class="table-container">
                    <table id="resultTable">
                        <thead>
                            <tr>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏¢‡∏≠‡∏î‡∏õ‡∏¥‡∏î</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>Sale</th>
                            </tr>
                        </thead>
                        <tbody id="resultTableBody"></tbody>
                        <tfoot id="resultTableFoot"></tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="full-width-section">
            <div class="table-box" style="height: auto; min-height: 400px;">
                <h3 style="color: #dc3545; display:flex; justify-content:space-between; align-items:center;">
                    ‚ö†Ô∏è ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ P2 ‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠ / ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤)
                    <span style="font-size:12px; font-weight:400; color:#666;">*‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                </h3>
                <div class="table-container">
                    <table id="pendingTable">
                        <thead>
                            <tr>
                                <th style="width: 10%;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà P2</th>
                                <th style="width: 15%;">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                <th style="width: 10%;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
                                <th style="width: 10%;">Sale</th>
                                <th style="width: 25%;">‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</th>
                                <th style="width: 30%;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            </tr>
                        </thead>
                        <tbody id="pendingTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
    // --- FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 1. Config & Init
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Global variable to store tracking data from Firestore
    let trackingState = {};
    let isFirebaseReady = false;

    // 2. Auth & Listeners
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (err) {
            console.error("Auth failed:", err);
            document.getElementById('statusMessage').innerHTML = `<span class="error">Database Auth Error: ${err.message}</span>`;
        }
    };
    initAuth();

    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Subscribe to Firestore changes
            const trackingCol = collection(db, 'artifacts', appId, 'public', 'data', 'p2_tracking');
            onSnapshot(trackingCol, (snapshot) => {
                trackingState = {};
                snapshot.forEach(doc => {
                    trackingState[doc.id] = doc.data();
                });
                isFirebaseReady = true;
                // If data is already displayed, refresh the pending table to show saved states
                if (document.getElementById('pendingTableBody').innerHTML !== "") {
                    refreshPendingTableUI(); 
                }
            }, (error) => {
                console.error("Snapshot error:", error);
            });
        }
    });

    // 3. Save Function
    window.saveTracking = async (id, field, value) => {
        if (!auth.currentUser) return;
        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'p2_tracking', id);
        try {
            await setDoc(ref, {
                [field]: value,
                lastUpdated: new Date().toISOString(),
                updatedBy: auth.currentUser.uid
            }, { merge: true });
        } catch (e) {
            console.error("Save failed", e);
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
        }
    };

    // --- MAIN APP LOGIC ---

    let rawData = [];
    let myChart = null;
    let pendingDetailsCache = []; // Cache for refreshing UI without re-calculating

    const SHEETS = {
        'Choc': '1F2bTvP1ySUT1q6fzRPQu7UpKNW_ze8GtKkd2rmRUjkI',
        'Bangyai': '1JU-rhoWIEHH4oSwIWApo8mUC8zQpNcT0Xd-70E_6CNM',
        'Sriracha': '1PdYqXkrrRGIv-6cCgOn8VXE6MpQhMlBGpFw7BbfzFbI',
        'Ram': '1LFoETe4YdPIxxj27bXxNRip9dKJ-sL7bbDv820ExEtk',
        'Bornsong': '1dlgM7YaQmJQTuiuNdAMb6tjKHllPgIs8MjfgGZnp8jU'
    };

    window.fetchAndProcessData = async function() {
        const branch = document.getElementById('branchSelector').value;
        const msg = document.getElementById('statusMessage');
        
        if(!branch) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡πà‡∏≠‡∏ô"); return; }

        const id = SHEETS[branch];
        const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv`;

        msg.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        msg.className = "";
        
        try {
            const resp = await fetch(url);
            const text = await resp.text();
            if (text.includes("google.com/accounts")) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ä‡∏£‡πå Sheet ‡πÄ‡∏õ‡πá‡∏ô Public");

            rawData = parseCSV(text);
            
            msg.innerHTML = `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${rawData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            msg.className = "success";
            
            document.getElementById('filterBtn').disabled = false;
            document.getElementById('clearBtn').disabled = false;
            document.getElementById('dashboardContent').style.display = 'block';
            
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            if(!document.getElementById('startDate').value) {
                 document.getElementById('startDate').valueAsDate = firstDay;
            }
            if(!document.getElementById('endDate').value) {
                document.getElementById('endDate').valueAsDate = today;
            }

            applyFiltersAndAnalyze();
        } catch (e) {
            msg.innerHTML = "‚ùå Error: " + e.message;
            msg.className = "error";
        }
    }

    window.applyFiltersAndAnalyze = function() {
        const start = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : null;
        const end = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : null;
        if(start) start.setHours(0,0,0,0);
        if(end) end.setHours(23,59,59,999);

        const userHistory = {};
        
        rawData.forEach(row => {
            const phone = getVal(row, '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠')?.trim();
            const date = parseDate(getVal(row, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'));
            const note = getVal(row, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏')?.trim().toUpperCase();
            
            if (!phone || !date) return;
            if (!userHistory[phone]) userHistory[phone] = [];
            userHistory[phone].push({ ...row, _date: date, _note: note });
        });

        let countP2_Targets = 0;
        let countP1_Converted = 0;
        let countUpP2_Converted = 0;
        let countTotal_UpP2_Bills = 0;

        let allSalesList = []; 
        let pendingDetails = [];
        
        const checkedKeysP2 = new Set();
        const checkedKeysAllUp = new Set(); 

        // 1. Calculate UP P2 Bills
        for (const phone in userHistory) {
            userHistory[phone].forEach(log => {
                if (!isWithin(log._date, start, end)) return;
                const dayKey = `${phone}_${log._date.getTime()}`;
                const amtUpP2 = parseAmount(getVal(log, '‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û P2'));
                
                if ((log._note === 'UP P2' || amtUpP2 > 0) && !checkedKeysAllUp.has(dayKey)) {
                    countTotal_UpP2_Bills++;
                    checkedKeysAllUp.add(dayKey);
                    allSalesList.push({
                        name: getVal(log, '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'),
                        status: 'UP P2',
                        amt: amtUpP2,
                        date: log._date,
                        sale: getVal(log, 'Sale'),
                        interest: getVal(log, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à')
                    });
                }
            });
        }

        // 2. Conversion Logic
        for (const phone in userHistory) {
            const logs = userHistory[phone].sort((a, b) => a._date - b._date);
            
            logs.forEach((log, idx) => {
                if (!isWithin(log._date, start, end)) return;

                const dayKey = `${phone}_${log._date.getTime()}`; // Unique ID for Firestore
                
                if (log._note === 'P2' && !checkedKeysP2.has(dayKey)) {
                    countP2_Targets++;
                    checkedKeysP2.add(dayKey);

                    let isConverted = false;
                    const p1AmtSelf = parseAmount(getVal(log, '‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û P1'));
                    const upP2AmtSelf = parseAmount(getVal(log, '‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û P2'));

                    if (p1AmtSelf > 0) { countP1_Converted++; isConverted = true; } 
                    else if (upP2AmtSelf > 0) { countUpP2_Converted++; isConverted = true; }

                    if (!isConverted) {
                        for (let i = idx + 1; i < logs.length; i++) {
                            const next = logs[i];
                            const p1AmtNext = parseAmount(getVal(next, '‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û P1'));
                            const upP2AmtNext = parseAmount(getVal(next, '‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û P2'));
                            const nextNote = next._note;

                            if (nextNote === 'P1' || p1AmtNext > 0) {
                                countP1_Converted++; isConverted = true; break;
                            } else if (nextNote === 'UP P2' || upP2AmtNext > 0) {
                                countUpP2_Converted++; isConverted = true; break;
                            }
                        }
                    }

                    if (!isConverted) {
                        pendingDetails.push({
                            id: dayKey, // ID for saving to DB
                            p2Date: log._date,
                            name: getVal(log, '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'),
                            phone: phone,
                            sale: getVal(log, 'Sale') || '-',
                            interest: getVal(log, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à') || '-'
                        });
                    }
                }
            });
        }

        const countNone = Math.max(0, countP2_Targets - (countP1_Converted + countUpP2_Converted));

        document.getElementById('totalP2').innerText = countP2_Targets;
        document.getElementById('totalAllUpP2').innerText = countTotal_UpP2_Bills;
        document.getElementById('countP1').innerText = countP1_Converted;
        document.getElementById('countUpP2').innerText = countUpP2_Converted;
        document.getElementById('countNone').innerText = countNone;

        const getPerc = (v) => countP2_Targets > 0 ? ((v/countP2_Targets)*100).toFixed(1) + '%' : '0%';
        document.getElementById('percP1').innerText = getPerc(countP1_Converted);
        document.getElementById('percUpP2').innerText = getPerc(countUpP2_Converted);
        document.getElementById('percNone').innerText = getPerc(countNone);

        updateChart(countP1_Converted, countUpP2_Converted, countNone);
        updateSuccessTable(allSalesList);
        
        // Cache pending details for UI refresh
        pendingDetailsCache = pendingDetails;
        refreshPendingTableUI();
    }

    window.refreshPendingTableUI = function() {
        const body = document.getElementById('pendingTableBody');
        const data = pendingDetailsCache;
        data.sort((a, b) => a.p2Date - b.p2Date);

        if (data.length === 0) {
            body.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color:#198754;">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</td></tr>';
            return;
        }

        body.innerHTML = data.map(row => {
            // Get saved state from trackingState
            const saved = trackingState[row.id] || {};
            const isCalled = saved.called || false;
            const isEntered = saved.entered || false;
            const note = saved.note || "";

            return `
            <tr>
                <td>${row.p2Date.toLocaleDateString('th-TH')}</td>
                <td><b>${row.name}</b></td>
                <td>${row.phone}</td>
                <td>${row.sale}</td>
                <td>
                    <div class="track-checkbox-group">
                        <label class="track-checkbox-label ${isCalled ? 'is-checked-call' : ''}">
                            <input type="checkbox" onchange="handleTrackChange('${row.id}', 'called', this.checked)" ${isCalled ? 'checked' : ''}>
                            üìû ‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡πâ‡∏ß
                        </label>
                        <label class="track-checkbox-label ${isEntered ? 'is-checked-enter' : ''}">
                            <input type="checkbox" onchange="handleTrackChange('${row.id}', 'entered', this.checked)" ${isEntered ? 'checked' : ''}>
                            üè• ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                        </label>
                    </div>
                </td>
                <td>
                    <input type="text" class="track-note-input" 
                           placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°..." 
                           value="${note}" 
                           onblur="handleTrackChange('${row.id}', 'note', this.value)">
                </td>
            </tr>
            `;
        }).join('');
    }

    window.handleTrackChange = function(id, type, value) {
        // Optimistic UI Update (Update visuals immediately)
        // Note: The main update happens via Firestore subscription, but this makes checkbox feel instant
        saveTracking(id, type, value);
        
        // Update class for styling immediately (optional, mainly for UX)
        if (type === 'called' || type === 'entered') {
            const el = document.activeElement;
            if (el && el.parentElement.classList.contains('track-checkbox-label')) {
                 if(value) el.parentElement.classList.add(type === 'called' ? 'is-checked-call' : 'is-checked-enter');
                 else el.parentElement.classList.remove(type === 'called' ? 'is-checked-call' : 'is-checked-enter');
            }
        }
    }

    // --- UTILS ---
    window.clearFilters = function() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        applyFiltersAndAnalyze();
    }

    function getVal(row, keyName) {
        if (!row) return '';
        if (row[keyName] !== undefined) return row[keyName];
        const target = keyName.replace(/\s+/g, '').toLowerCase();
        for (let k in row) {
            if (k.replace(/\s+/g, '').toLowerCase() === target) return row[k];
        }
        return '';
    }

    function parseCSV(text) {
        const lines = text.split('\n');
        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
        return lines.slice(1).map(line => {
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const obj = {};
            headers.forEach((h, i) => obj[h] = values[i] ? values[i].replace(/"/g, '').trim() : '');
            return obj;
        });
    }

    function parseDate(s) {
        if (!s) return null;
        const parts = s.split(/[\/\-\.]/);
        if (parts.length < 3) return null;
        let p0 = parseInt(parts[0]), p1 = parseInt(parts[1]), p2 = parseInt(parts[2]);
        let d, m, y;
        if (p1 > 12) { m = p0; d = p1; y = p2; } else { m = p0; d = p1; y = p2; }
        if (y > 2500) y -= 543;
        if (y < 100) y += 2000;
        return new Date(y, m - 1, d);
    }

    function parseAmount(str) {
        if (!str) return 0;
        if (typeof str !== 'string') str = String(str);
        return parseFloat(str.replace(/,/g, '')) || 0;
    }

    function isWithin(d, s, e) {
        if (!d) return false;
        if (s && d < s) return false;
        if (e && d > e) return false;
        return true;
    }

    function updateChart(p1, up, none) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô P1', '‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î UP P2', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'],
                datasets: [{
                    data: [p1, up, none],
                    backgroundColor: ['#198754', '#ffc107', '#adb5bd']
                }]
            },
            options: { maintainAspectRatio: false }
        });
    }

    function updateSuccessTable(data) {
        const body = document.getElementById('resultTableBody');
        const footer = document.getElementById('resultTableFoot');
        data.sort((a, b) => b.date - a.date);
        
        body.innerHTML = data.length ? data.map(row => `
            <tr>
                <td><b>${row.name}</b></td>
                <td style="font-size:13px; color:#555;">${row.interest || '-'}</td>
                <td><span class="status-badge bg-total-up">${row.status}</span></td>
                <td>${Number(row.amt || 0).toLocaleString()}</td>
                <td>${row.date.toLocaleDateString('th-TH')}</td>
                <td>${row.sale || '-'}</td>
            </tr>
        `).join('') : '<tr><td colspan="6" style="text-align:center; padding: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ UP P2 ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</td></tr>';

        const total = data.reduce((sum, row) => sum + (row.amt || 0), 0);
        footer.innerHTML = data.length ? `<tr><td colspan="3" style="text-align:right;">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</td><td style="color:#198754; font-size:18px;">${total.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td><td colspan="2"></td></tr>` : '';
    }
</script>

</body>
</html>
